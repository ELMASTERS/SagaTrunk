<?xml version="1.0" encoding="iso-8859-1" ?>
<?xml-stylesheet type="text/xsl" href="xslt/techdoc.xsl"?>
<page logo="techdoc">
  <title>How to script quests</title>
  <paragraph>You need an svn client such as toirtoise svn or subversion. Once you have installed the client you can do a checkout from https://svn1.hosted-projects.com/SagaE/SagaRev/Quests/ which is our subversion base for all scripted quests. Along with the quests there is a file called: 'Quest-Progress.txt'. That file contains an summary of the current progress of scripted quests. The quests are saved in their unpacked form in a file such as '{QuestId}.lua'.</paragraph>
  <paragraph>On our forums you can find diverse xml based files containing information used for scripters. You can use this files as references to lookup itemid's, actionobject's and npc's. We use numeric id's because it's better for the server and reduces chances of spelling flaws.</paragraph>
  <paragraph>Please open quest 174 from our svn repro. You'll notice that the quest starts with</paragraph>

  <code><![CDATA[
-- Saga is Licensed under Creative Commons Attribution-NonCommerial-ShareAlike 3.0 License
-- http://creativecommons.org/licenses/by-nc-sa/3.0/
-- Generated By Quest Extractor on 2/8/2008 3:46:15 PM

local QuestID = 174;
local ReqClv = 16;
local ReqJlv = 0;
local NextQuest = 175;
local RewZeny = 300;
local RewCxp = 1700;
local RewJxp = 680;
local RewWxp = 0; 
local RewItem1 = 1700113; 
local RewItem2 = 0; 
local RewItemCount1 = 3; 
local RewItemCount2 = 0; 
local StepID = 0;   

-- Modify steps below for gameplay
]]></code>

  <paragraph>This is the quest header. We collect and update information in this general header. This information is generated by a tool from an packetlog database we've created. Using the header makes it seamlessly easier to manage all quests. All these variables are declared outside the scope of an function and makes  them global accessable. Most of our functions you find in the scripted quests you'll find they use one or  multiple of these variables. This is done because this way you only have to change the required fields for a productive quest.</paragraph>
  <paragraph>If we examine the body of an quest we can have four important entry points for our server.</paragraph>

  <code><![CDATA[
QUEST_START(cid) This function is called when the quest starts 
QUEST_FINISH(cid) This function is called when the user presses the 'finish' button
QUEST_CANCEL(cid) This function is called when the user cancels the quest
QUEST_CHECK(cid) This function is called to check the quest for quest progress.
]]></code>

  <paragraph>Now to get started please refer to 'QuestStepData.xml' from the xml database. This file contains every action a person has to furfill in order to complete a quest. Every quest consist out of a number of steps. Those steps are build upon substeps. A step must be completed in the same order they are created. A substep however can be completed in an random order. Now when we look at our xml file we can see an bunch of xml-tags with the name 'script{n}' (where n is a number from 1 to 22). Each of these scripts contain information about type of action. Why they are seperated is unknown, but it helps verifying if a quest does what you expect it to do.</paragraph>
  <paragraph>If you lookup all steps for quest 174 you find: 17401 - Talk with Volker Stanwood; 17402 - Eliminate Spore (7);17403 - Hand in to Kafra Board Mailbox. We clearly see the quest has three steps. So we add these three steps to the quest check and quest start functions. The code below are two snippits for them:</paragraph>
  
  <code><![CDATA[
function QUEST_START(cid)    
    Saga.AddStep(cid, QuestID, 17401);
    Saga.AddStep(cid, QuestID, 17402);    
    Saga.AddStep(cid, QuestID, 17403);   
    Saga.InsertQuest(cid, QuestID, 1);    
    return 0;
end

function QUEST_CHECK(cid)
    local CurStepID = Saga.GetStepIndex(cid, QuestID );
    StepID = CurStepID;
    local ret = -1;

    if CurStepID == 17401 then
        ret = QUEST_STEP_1(cid);
    elseif CurStepID == 17402 then   
        ret = QUEST_STEP_2(cid);  
    elseif CurStepID == 17403 then   
        ret = QUEST_STEP_3(cid);          
    end
    
    if ret == 0 then
        QUEST_CHECK(cid)
    end
    
    return ret;    
end
]]></code>

  <paragraph>As you notice we add each step of the quest by using 'QUEST_STEP_{n}' where n is the numeric value in which order the quests are done. If you return -1 in a step function it aborts. However if you return 0 it aborts and rechecks. So assume you complete a step and return 0 it not rechecks the step but checks the new step instead.</paragraph>

  <code><![CDATA[
function QUEST_STEP_1(cid)  
    -- Talk with Volker Stanwood
    Saga.AddWaypoint(cid, QuestID, StepID, 1,1009);      
    
    -- Check for completion
    local ret = Saga.GetNPCIndex(cid);    
    if ret == 1009 then
        Saga.GeneralDialog(cid, 3936);               
        Saga.SubstepComplete(cid, QuestID, StepID, 1);                
    end    
    
    -- Check if all substeps are completed
    for i = 1, 1 do
         if Saga.IsSubStepCompleted(cid,QuestID,StepID, i) == false then
            return -1;
         end
    end        
    
    Saga.StepComplete(cid, QuestID, StepID);
    Saga.ClearWaypoints(cid, QuestID); 
    return 0;
end
]]></code>

  <paragraph>The code above is an snippit for the first step. Earlier we stated that our first step was to talk to volker stanwood. If you lookup Volker stanwoord in the 'npc.xml' you'll notice his npcid is 1009. The number one represents for the substep. In case you want to talk to multiple npc's you'll add the AddWaypoint function with different substepid. The substeps always start with number 1 and increment for every extra substep.</paragraph>
  <paragraph>And here is the rest of the quest.</paragraph>

  <code><![CDATA[
function QUEST_STEP_2(cid)
    -- Eliminate Spore (7)
    Saga.Eliminate(cid, QuestID, StepID, 10081, 7, 1);
	Saga.Eliminate(cid, QuestID, StepID, 10082, 7, 1); 
	
    -- Check if all substeps are completed
    for i = 1, 1 do
         if Saga.IsSubStepCompleted(cid,QuestID,StepID, i) == false then
			return -1;
		 end
    end	
    
    Saga.StepComplete(cid, QuestID, StepID);     
    return 0;
end

function QUEST_STEP_3(cid)
    -- Hand in to Kafra Board Mailbox
    local ret = Saga.GetActionObjectIndex(cid);    
    if ret == 1123 then
        Saga.SubstepComplete(cid, QuestID, StepID, 1);       
    end    
    
    -- Check if all substeps are completed
    for i = 1, 1 do
         if Saga.IsSubStepCompleted(cid,QuestID,StepID, i) == false then
            return -1;
         end
    end    
    
    Saga.StepComplete(cid, QuestID, StepID);
    Saga.ClearWaypoints(cid, QuestID); 
    Saga.QuestComplete(cid, QuestID);    
    return -1;
end

]]></code>

</page>